----------------------------------------
-- Solar Vehicle with CAN Bus
-- AADL Inspector
-- (c) Ellidiss Technologies
-- Updated: March 2023
----------------------------------------

PACKAGE canbus_Pkg
PUBLIC
WITH Bus_Properties;
WITH canbus_Types;
RENAMES canbus_Types::ALL;

SYSTEM CanBus
END CanBus;

SYSTEM IMPLEMENTATION CanBus.others
SUBCOMPONENTS
  Dashboard : SYSTEM Dashboard.others;
  SolarCells : SYSTEM SolarCells.others;
  Batteries : SYSTEM Batteries.others;
  Motors : SYSTEM Motors.others;
  Signalling : SYSTEM Signalling.others;
  MainECU : SYSTEM MainECU.others;
  CAN : BUS CAN.others;
CONNECTIONS
  cnx_0 : PORT Dashboard.commands -> MainECU.commands;
  cnx_1 : PORT SolarCells.status -> MainECU.cells_status;
  cnx_2 : PORT Batteries.status -> MainECU.batteries_status;
  cnx_3 : PORT Motors.status -> MainECU.motors_status;
  cnx_4 : PORT MainECU.status -> Dashboard.status;
  cnx_5 : PORT MainECU.batteries_control -> Batteries.control;
  cnx_6 : PORT MainECU.motors_control -> Motors.control;
  cnx_7 : PORT MainECU.signals_control -> Signalling.control;
  cnx_8 : BUS ACCESS CAN -> Dashboard.CAN;
  cnx_9 : BUS ACCESS CAN -> SolarCells.CAN;
  cnx_10 : BUS ACCESS CAN -> Batteries.CAN;
  cnx_11 : BUS ACCESS CAN -> Motors.CAN;
  cnx_12 : BUS ACCESS CAN -> Signalling.CAN;
  cnx_13 : BUS ACCESS CAN -> MainECU.CAN;
PROPERTIES
  Actual_Connection_Binding => (REFERENCE(CAN)) APPLIES TO cnx_0;
  Actual_Connection_Binding => (REFERENCE(CAN)) APPLIES TO cnx_1;
  Actual_Connection_Binding => (REFERENCE(CAN)) APPLIES TO cnx_2;
  Actual_Connection_Binding => (REFERENCE(CAN)) APPLIES TO cnx_3;
  Actual_Connection_Binding => (REFERENCE(CAN)) APPLIES TO cnx_4;
  Actual_Connection_Binding => (REFERENCE(CAN)) APPLIES TO cnx_5;
  Actual_Connection_Binding => (REFERENCE(CAN)) APPLIES TO cnx_6;
  Actual_Connection_Binding => (REFERENCE(CAN)) APPLIES TO cnx_7;
END CanBus.others;

BUS CAN
END CAN;

BUS IMPLEMENTATION CAN.others
PROPERTIES
  Bus_Properties::Channel_Type => Full_Duplex;
  Transmission_Type => PUSH;
  Transmission_Time => 
    [ Fixed => 1 ms..1 ms;
      PerByte => 1 us..1 us; ];
END CAN.others;

SYSTEM Dashboard
FEATURES
  commands : OUT DATA PORT TCommand.others;
  status : IN DATA PORT TStatus.others;
  CAN : REQUIRES BUS ACCESS CAN.others;
END Dashboard;

SYSTEM IMPLEMENTATION Dashboard.others
SUBCOMPONENTS
  DashboardSW : PROCESS DashboardSW.others;
  DashboardCPU : PROCESSOR DashboardCPU.others;
  DashboardMemory : MEMORY DashboardMemory.others;
  ControlPanel : DEVICE ControlPanel.others;
  DisplayScreen : DEVICE DisplayScreen.others;
CONNECTIONS
  cnx_0 : PORT DashboardSW.commandsOut -> commands;
  cnx_1 : PORT status -> DashboardSW.statusIn;
  cnx_2 : PORT DashboardSW.statusOut -> DisplayScreen.status;
  cnx_3 : PORT ControlPanel.commands -> DashboardSW.commandsIn;
  cnx_4 : BUS ACCESS CAN -> DashboardCPU.CAN;
PROPERTIES
  Actual_Processor_Binding => (REFERENCE(DashboardCPU)) APPLIES TO DashboardSW;
  Actual_Memory_Binding => (REFERENCE(DashboardMemory)) APPLIES TO DashboardSW;
END Dashboard.others;

PROCESSOR DashboardCPU
FEATURES
  CAN : REQUIRES BUS ACCESS CAN.others;
END DashboardCPU;

PROCESSOR IMPLEMENTATION DashboardCPU.others
PROPERTIES
  Scheduling_Protocol => (RATE_MONOTONIC_PROTOCOL);
END DashboardCPU.others;

PROCESS DashboardSW
FEATURES
  commandsOut : OUT DATA PORT TCommand.others;
  statusIn : IN DATA PORT TStatus.others;
  commandsIn : IN DATA PORT TCommand.others;
  statusOut : OUT DATA PORT TStatus.others;
END DashboardSW;

PROCESS IMPLEMENTATION DashboardSW.others
SUBCOMPONENTS
  ElaborateCommand : THREAD ElaborateCommand.others;
  DisplayStatus : THREAD DisplayStatus.others;
CONNECTIONS
  cnx_0 : PORT ElaborateCommand.output -> commandsOut;
  cnx_1 : PORT commandsIn -> ElaborateCommand.input;
  cnx_2 : PORT statusIn -> DisplayStatus.input;
  cnx_3 : PORT DisplayStatus.output -> statusOut;
END DashboardSW.others;

THREAD ElaborateCommand
FEATURES
  output : OUT DATA PORT TCommand.others;
  input : IN DATA PORT TCommand.others;
END ElaborateCommand;

THREAD IMPLEMENTATION ElaborateCommand.others
PROPERTIES
  Dispatch_Protocol => Periodic;
  Compute_Execution_Time => 2 ms..2 ms;
  Deadline => 20 ms;
  Period => 20 ms;
END ElaborateCommand.others;

THREAD DisplayStatus
FEATURES
  input : IN DATA PORT TStatus.others;
  output : OUT DATA PORT TStatus.others;
END DisplayStatus;

THREAD IMPLEMENTATION DisplayStatus.others
PROPERTIES
  Dispatch_Protocol => Periodic;
  Compute_Execution_Time => 2 ms..2 ms;
  Deadline => 10 ms;
  Period => 10 ms;
END DisplayStatus.others;

MEMORY DashboardMemory
END DashboardMemory;

MEMORY IMPLEMENTATION DashboardMemory.others
END DashboardMemory.others;

DEVICE ControlPanel
FEATURES
  commands : OUT DATA PORT TCommand.others;
END ControlPanel;

DEVICE IMPLEMENTATION ControlPanel.others
END ControlPanel.others;

DEVICE DisplayScreen
FEATURES
  status : IN DATA PORT TStatus.others;
END DisplayScreen;

DEVICE IMPLEMENTATION DisplayScreen.others
END DisplayScreen.others;

SYSTEM SolarCells
FEATURES
  status : OUT DATA PORT TStatus.others;
  CAN : REQUIRES BUS ACCESS CAN.others;
END SolarCells;

SYSTEM IMPLEMENTATION SolarCells.others
END SolarCells.others;

SYSTEM Batteries
FEATURES
  status : OUT DATA PORT TStatus.others;
  control : IN DATA PORT TControl.others;
  CAN : REQUIRES BUS ACCESS CAN.others;
END Batteries;

SYSTEM IMPLEMENTATION Batteries.others
END Batteries.others;

SYSTEM Motors
FEATURES
  status : OUT DATA PORT TStatus.others;
  control : IN DATA PORT TControl.others;
  CAN : REQUIRES BUS ACCESS CAN.others;
END Motors;

SYSTEM IMPLEMENTATION Motors.others
SUBCOMPONENTS
  MotorsSW : PROCESS MotorsSW.others;
  MotorsCPU : PROCESSOR MotorsCPU.others;
  MotorsMemory : MEMORY MotorsMemory.others;
  RightMotor : DEVICE Motor.others;
  LeftMotor : DEVICE Motor.others;
CONNECTIONS
  cnx_0 : PORT MotorsSW.status -> status;
  cnx_1 : PORT control -> MotorsSW.control;
  cnx_2 : PORT MotorsSW.control_right -> RightMotor.control;
  cnx_3 : PORT MotorsSW.control_left -> LeftMotor.control;
  cnx_4 : PORT RightMotor.status -> MotorsSW.status_right;
  cnx_5 : PORT LeftMotor.status -> MotorsSW.status_left;
  cnx_6 : BUS ACCESS CAN -> MotorsCPU.CAN;
PROPERTIES
  Actual_Processor_Binding => (REFERENCE(MotorsCPU)) APPLIES TO MotorsSW;
  Actual_Memory_Binding => (REFERENCE(MotorsMemory)) APPLIES TO MotorsSW;
END Motors.others;

PROCESS MotorsSW
FEATURES
  status : OUT DATA PORT TStatus.others;
  control : IN DATA PORT TControl.others;
  status_right : IN DATA PORT TStatus.others;
  control_right : OUT DATA PORT TControl.others;
  status_left : IN DATA PORT TStatus.others;
  control_left : OUT DATA PORT TControl.others;
END MotorsSW;

PROCESS IMPLEMENTATION MotorsSW.others
SUBCOMPONENTS
  MotorsManager : THREAD MotorsManager.others;
  RightController : THREAD MotorController.others {
    Dispatch_Protocol => Periodic;
    Compute_Execution_Time => 2 ms..2 ms;
    Deadline => 15 ms;
    Period => 15 ms;
  };
  LeftController : THREAD MotorController.others {
    Dispatch_Protocol => Periodic;
    Compute_Execution_Time => 2 ms..2 ms;
    Deadline => 15 ms;
    Period => 15 ms;
  };
CONNECTIONS
  cnx_0 : PORT status_right -> RightController.status_in;
  cnx_1 : PORT RightController.control_out -> control_right;
  cnx_2 : PORT status_left -> LeftController.status_in;
  cnx_3 : PORT LeftController.control_out -> control_left;
  cnx_4 : PORT MotorsManager.status -> status;
  cnx_5 : PORT control -> MotorsManager.control;
  cnx_6 : PORT RightController.status_out -> MotorsManager.status_right;
  cnx_7 : PORT LeftController.status_out -> MotorsManager.status_left;
  cnx_8 : PORT MotorsManager.control_right -> RightController.control_in;
  cnx_9 : PORT MotorsManager.control_left -> LeftController.control_in;
END MotorsSW.others;

THREAD MotorController
FEATURES
  status_out : OUT DATA PORT TStatus.others;
  control_in : IN DATA PORT TControl.others;
  status_in : IN DATA PORT TStatus.others;
  control_out : OUT DATA PORT TControl.others;
END MotorController;

THREAD IMPLEMENTATION MotorController.others
END MotorController.others;

THREAD MotorsManager
FEATURES
  status : OUT DATA PORT TStatus.others;
  control : IN DATA PORT TControl.others;
  status_right : IN DATA PORT TStatus.others;
  control_right : OUT DATA PORT TControl.others;
  status_left : IN DATA PORT TStatus.others;
  control_left : OUT DATA PORT TControl.others;
END MotorsManager;

THREAD IMPLEMENTATION MotorsManager.others
PROPERTIES
  Dispatch_Protocol => Periodic;
  Compute_Execution_Time => 3 ms..3 ms;
  Deadline => 10 ms;
  Period => 10 ms;
END MotorsManager.others;

PROCESSOR MotorsCPU
FEATURES
  CAN : REQUIRES BUS ACCESS CAN.others;
END MotorsCPU;

PROCESSOR IMPLEMENTATION MotorsCPU.others
PROPERTIES
  Scheduling_Protocol => (RATE_MONOTONIC_PROTOCOL);
END MotorsCPU.others;

MEMORY MotorsMemory
END MotorsMemory;

MEMORY IMPLEMENTATION MotorsMemory.others
END MotorsMemory.others;

DEVICE Motor
FEATURES
  status : OUT DATA PORT TStatus.others;
  control : IN DATA PORT TControl.others;
END Motor;

DEVICE IMPLEMENTATION Motor.others
END Motor.others;

SYSTEM Signalling
FEATURES
  control : IN DATA PORT TControl.others;
  CAN : REQUIRES BUS ACCESS CAN.others;
END Signalling;

SYSTEM IMPLEMENTATION Signalling.others
END Signalling.others;

SYSTEM MainECU
FEATURES
  commands : IN DATA PORT TCommand.others;
  status : OUT DATA PORT TStatus.others;
  signals_control : OUT DATA PORT TControl.others;
  cells_status : IN DATA PORT TStatus.others;
  motors_status : IN DATA PORT TStatus.others;
  motors_control : OUT DATA PORT TControl.others;
  batteries_status : IN DATA PORT TStatus.others;
  batteries_control : OUT DATA PORT TControl.others;
  CAN : REQUIRES BUS ACCESS CAN.others;
END MainECU;

SYSTEM IMPLEMENTATION MainECU.others
SUBCOMPONENTS
  MainCPU : PROCESSOR MainCPU.others;
  MainSW : PROCESS MainSW.others;
  MainMemory : MEMORY MainMemory.others;
CONNECTIONS
  cnx_0 : PORT commands -> MainSW.commands;
  cnx_1 : PORT MainSW.status -> status;
  cnx_2 : PORT MainSW.signals_control -> signals_control;
  cnx_3 : PORT cells_status -> MainSW.cells_status;
  cnx_4 : PORT motors_status -> MainSW.motors_status;
  cnx_5 : PORT MainSW.motors_control -> motors_control;
  cnx_6 : PORT batteries_status -> MainSW.batteries_status;
  cnx_7 : PORT MainSW.batteries_control -> batteries_control;
  cnx_8 : BUS ACCESS CAN -> MainCPU.CAN;
PROPERTIES
  Actual_Processor_Binding => (REFERENCE(MainCPU)) APPLIES TO MainSW;
  Actual_Memory_Binding => (REFERENCE(MainMemory)) APPLIES TO MainSW;
END MainECU.others;

PROCESSOR MainCPU
FEATURES
  CAN : REQUIRES BUS ACCESS CAN.others;
END MainCPU;

PROCESSOR IMPLEMENTATION MainCPU.others
PROPERTIES
  Scheduling_Protocol => (RATE_MONOTONIC_PROTOCOL);
END MainCPU.others;

PROCESS MainSW
FEATURES
  commands : IN DATA PORT TCommand.others;
  status : OUT DATA PORT TStatus.others;
  signals_control : OUT DATA PORT TControl.others;
  cells_status : IN DATA PORT TStatus.others;
  motors_status : IN DATA PORT TStatus.others;
  motors_control : OUT DATA PORT TControl.others;
  batteries_status : IN DATA PORT TStatus.others;
  batteries_control : OUT DATA PORT TControl.others;
END MainSW;

PROCESS IMPLEMENTATION MainSW.others
SUBCOMPONENTS
  ControlManager : THREAD ControlManager.others;
  StatusManager : THREAD StatusManager.others;
  CarStatus : DATA TStatus.others;
CONNECTIONS
  cnx_0 : PORT commands -> ControlManager.commands;
  cnx_1 : PORT ControlManager.signals -> signals_control;
  cnx_2 : PORT ControlManager.motors -> motors_control;
  cnx_3 : PORT ControlManager.batteries -> batteries_control;
  cnx_4 : PORT StatusManager.status -> status;
  cnx_5 : PORT cells_status -> StatusManager.cells;
  cnx_6 : PORT motors_status -> StatusManager.motors;
  cnx_7 : PORT batteries_status -> StatusManager.batteries;
  cnx_8 : DATA ACCESS CarStatus -> ControlManager.CarStatus;
  cnx_9 : DATA ACCESS CarStatus -> StatusManager.CarStatus;
END MainSW.others;

THREAD ControlManager
FEATURES
  commands : IN DATA PORT TCommand.others;
  signals : OUT DATA PORT TControl.others;
  motors : OUT DATA PORT TControl.others;
  batteries : OUT DATA PORT TControl.others;
  CarStatus : REQUIRES DATA ACCESS TStatus.others;
END ControlManager;

THREAD IMPLEMENTATION ControlManager.others
PROPERTIES
  Dispatch_Protocol => Periodic;
  Compute_Execution_Time => 5 ms..5 ms;
  Deadline => 20 ms;
  Period => 20 ms;
END ControlManager.others;

THREAD StatusManager
FEATURES
  status : OUT DATA PORT TStatus.others;
  cells : IN DATA PORT TStatus.others;
  motors : IN DATA PORT TStatus.others;
  batteries : IN DATA PORT TStatus.others;
  CarStatus : REQUIRES DATA ACCESS TStatus.others;
END StatusManager;

THREAD IMPLEMENTATION StatusManager.others
PROPERTIES
  Dispatch_Protocol => Periodic;
  Compute_Execution_Time => 3 ms..3 ms;
  Deadline => 10 ms;
  Period => 10 ms;
END StatusManager.others;

MEMORY MainMemory
END MainMemory;

MEMORY IMPLEMENTATION MainMemory.others
END MainMemory.others;

END canbus_Pkg;



